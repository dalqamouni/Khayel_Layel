<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genesys Cloud Recording Downloader</title>
</head>
<body>
    <h1>Genesys Cloud Recording Downloader</h1>
    <button onclick="startDownload()">Download Recordings</button>
    <p id="status">Status: Waiting</p>
    
    <script>
        async function startDownload() {
            document.getElementById("status").innerText = "Status: Authenticating...";
            
            const CLIENT_ID = "485e10e6-44be-4a4f-adf5-f4661cdaa335";
            const CLIENT_SECRET = "dqakz-pDeRaekvSEVfFtz8dgbeLqHNdasIhEFOJpmG4";
            const REGION = "eu-west-1"; // Example: "mypurecloud.ie"
            const START_DATE = "2025-03-01T13:00:00.000Z";
            const END_DATE = "2025-03-01T14:00:00.000Z";
            
            try {
                // Step 1: Authenticate
                let authResponse = await fetch(`https://login.${REGION}/oauth/token`, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: `grant_type=client_credentials&client_id=${CLIENT_ID}&client_secret=${CLIENT_SECRET}`
                });
                
                if (!authResponse.ok) throw new Error("Authentication failed");
                let authData = await authResponse.json();
                let accessToken = authData.access_token;
                document.getElementById("status").innerText = "Status: Fetching Conversations...";
                
                // Step 2: Fetch Conversations
                let conversationsResponse = await fetch(`https://api.${REGION}/api/v2/analytics/conversations/details/query`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ "interval": `${START_DATE}/${END_DATE}` })
                });
                
                let conversationsData = await conversationsResponse.json();
                let batchRequestList = [];
                
                for (let conversation of conversationsData.conversations) {
                    let recordingsResponse = await fetch(`https://api.${REGION}/api/v2/conversations/${conversation.conversationId}/recordings`, {
                        headers: { "Authorization": `Bearer ${accessToken}` }
                    });
                    let recordingsData = await recordingsResponse.json();
                    
                    for (let recording of recordingsData) {
                        batchRequestList.push({
                            conversationId: recording.conversationId,
                            recordingId: recording.id
                        });
                    }
                }
                
                document.getElementById("status").innerText = "Status: Requesting Batch Download...";
                
                // Step 3: Request Batch Download
                let batchResponse = await fetch(`https://api.${REGION}/api/v2/recording/batchrequests`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ batchDownloadRequestList: batchRequestList })
                });
                let batchData = await batchResponse.json();
                let batchId = batchData.id;
                
                // Step 4: Poll for Completion
                let batchStatus = "Processing";
                while (batchStatus === "Processing") {
                    await new Promise(r => setTimeout(r, 5000)); // Wait 5 sec
                    let statusResponse = await fetch(`https://api.${REGION}/api/v2/recording/batchrequests/${batchId}`, {
                        headers: { "Authorization": `Bearer ${accessToken}` }
                    });
                    let statusData = await statusResponse.json();
                    batchStatus = statusData.status;
                    
                    if (batchStatus === "Completed") {
                        document.getElementById("status").innerText = "Status: Downloading...";
                        for (let recording of statusData.results) {
                            if (!recording.errorMsg) {
                                window.open(recording.resultUrl, '_blank');
                            }
                        }
                        document.getElementById("status").innerText = "Status: Completed";
                        return;
                    }
                }
                
            } catch (error) {
                document.getElementById("status").innerText = "Status: Error - " + error.message;
            }
        }
    </script>
</body>
</html>
