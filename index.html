const express = require("express");
const cors = require("cors");
const axios = require("axios");

const app = express();
const PORT = 3000;

app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

const CLIENT_ID = "485e10e6-44be-4a4f-adf5-f4661cdaa335";
const CLIENT_SECRET = "dqakz-pDeRaekvSEVfFtz8dgbeLqHNdasIhEFOJpmG4";
const REGION = "mypurecloud.ie"; // Change if needed

// Generate Base64 Auth Token
const authHeader = `Basic ${Buffer.from(`${CLIENT_ID}:${CLIENT_SECRET}`).toString("base64")}`;

// Endpoint to get an OAuth token
app.post("/api/token", async (req, res) => {
    try {
        const response = await axios.post(
            `https://login.${REGION}/oauth/token`,
            "grant_type=client_credentials",
            {
                headers: {
                    "Authorization": authHeader,
                    "Content-Type": "application/x-www-form-urlencoded"
                }
            }
        );
        res.json(response.data);
    } catch (error) {
        res.status(500).json({ error: "Authentication failed", details: error.message });
    }
});

// Endpoint to fetch conversation details
app.post("/api/conversations", async (req, res) => {
    try {
        const { accessToken, startDate, endDate } = req.body;
        const response = await axios.post(
            `https://api.${REGION}/api/v2/analytics/conversations/details/query`,
            { interval: `${startDate}/${endDate}` },
            {
                headers: {
                    Authorization: `Bearer ${accessToken}`,
                    "Content-Type": "application/json"
                }
            }
        );
        res.json(response.data);
    } catch (error) {
        res.status(500).json({ error: "Failed to fetch conversations", details: error.message });
    }
});

// Endpoint to fetch recordings for a conversation
app.post("/api/recordings", async (req, res) => {
    try {
        const { accessToken, conversationId } = req.body;
        const response = await axios.get(
            `https://api.${REGION}/api/v2/conversations/${conversationId}/recordings`,
            {
                headers: {
                    Authorization: `Bearer ${accessToken}`
                }
            }
        );
        res.json(response.data);
    } catch (error) {
        res.status(500).json({ error: "Failed to fetch recordings", details: error.message });
    }
});

// Start server
app.listen(PORT, () => console.log(`Proxy server running on http://localhost:${PORT}`));
