<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genesys Cloud Recording Downloader</title>
</head>
<body>
    <h1>Genesys Cloud Recording Downloader</h1>
    <button onclick="startDownload()">Start Download Recordings</button>
    <p id="status">Status: Waiting</p>
    <progress id="progressBar" value="0" max="100" style="width:100%; display:none;"></progress>
    
    <script>
        async function startDownload() {
            document.getElementById("status").innerText = "Status: Authenticating...";
            document.getElementById("progressBar").style.display = "block";
            document.getElementById("progressBar").value = 10;
            
            const START_DATE = "2025-03-01T13:00:00.000Z";
            const END_DATE = "2025-03-01T14:00:00.000Z";

            try {
                // Step 1: Authenticate via the proxy
                let authResponse = await fetch("http://localhost:3000/api/token", { method: "POST" });
                if (!authResponse.ok) throw new Error("Authentication failed");

                let authData = await authResponse.json();
                let accessToken = authData.access_token;

                document.getElementById("status").innerText = "Status: Fetching Conversations...";
                document.getElementById("progressBar").value = 30;

                // Step 2: Fetch conversations via the proxy
                let conversationsResponse = await fetch("http://localhost:3000/api/conversations", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ accessToken, startDate: START_DATE, endDate: END_DATE })
                });

                let conversationsData = await conversationsResponse.json();
                let batchRequestList = [];

                for (let conversation of conversationsData.conversations) {
                    let recordingsResponse = await fetch("http://localhost:3000/api/recordings", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ accessToken, conversationId: conversation.conversationId })
                    });

                    let recordingsData = await recordingsResponse.json();
                    for (let recording of recordingsData) {
                        batchRequestList.push({ conversationId: recording.conversationId, recordingId: recording.id });
                    }
                }

                document.getElementById("status").innerText = "Status: Requesting Batch Download...";
                document.getElementById("progressBar").value = 50;

                let batchResponse = await fetch("http://localhost:3000/api/recording/batchrequests", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ batchDownloadRequestList: batchRequestList })
                });

                let batchData = await batchResponse.json();
                let batchId = batchData.id;

                let batchStatus = "Processing";
                while (batchStatus === "Processing") {
                    await new Promise(r => setTimeout(r, 5000));
                    let statusResponse = await fetch(`http://localhost:3000/api/recording/batchrequests/${batchId}`, {
                        headers: { "Authorization": `Bearer ${accessToken}` }
                    });

                    let statusData = await statusResponse.json();
                    batchStatus = statusData.status;
                    document.getElementById("progressBar").value = 75;

                    if (batchStatus === "Completed") {
                        document.getElementById("status").innerText = "Status: Downloading...";
                        document.getElementById("progressBar").value = 90;

                        for (let recording of statusData.results) {
                            if (!recording.errorMsg) {
                                let a = document.createElement("a");
                                a.href = recording.resultUrl;
                                a.download = "recording.mp3";
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                            }
                        }

                        document.getElementById("status").innerText = "Status: Download Complete";
                        document.getElementById("progressBar").value = 100;
                        return;
                    }
                }

            } catch (error) {
                document.getElementById("status").innerText = "Status: Error - " + error.message;
                document.getElementById("progressBar").style.display = "none";
            }
        }
    </script>
</body>
</html>
